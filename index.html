<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Trouwfoto's Upload - Rick & Chantal üíï</title>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 30px;
            max-width: 500px;
            width: 100%;
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            color: #4a5568;
            font-size: 28px;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            color: #718096;
            font-size: 16px;
        }

        /* Status Box */
        .status-box {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 14px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .status-loading {
            background: #e0e7ff;
            color: #3730a3;
            border: 1px solid #a5b4fc;
        }

        .status-success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #6ee7b7;
        }

        .status-error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fca5a5;
        }

        .status-warning {
            background: #fed7aa;
            color: #92400e;
            border: 1px solid #fb923c;
        }

        /* Setup Panel */
        .setup-panel {
            background: #f3f4f6;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
        }

        .setup-panel h2 {
            color: #1f2937;
            font-size: 20px;
            margin-bottom: 20px;
            text-align: center;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            color: #4b5563;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group textarea {
            min-height: 120px;
            font-family: monospace;
            font-size: 13px;
            resize: vertical;
        }

        .form-group small {
            display: block;
            color: #6b7280;
            font-size: 12px;
            margin-top: 5px;
        }

        /* Upload Interface */
        .upload-panel {
            display: none;
        }

        .upload-panel.active {
            display: block;
        }

        /* Upload Buttons */
        .upload-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 25px;
        }

        .upload-btn {
            background: white;
            border: 3px solid #e5e7eb;
            border-radius: 15px;
            padding: 25px 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .upload-btn:hover:not(.disabled) {
            border-color: #667eea;
            background: #f3f4f6;
            transform: translateY(-2px);
        }

        .upload-btn.disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .upload-btn-icon {
            font-size: 40px;
            margin-bottom: 10px;
        }

        .upload-btn-text {
            color: #4b5563;
            font-size: 14px;
            font-weight: 600;
        }

        /* Preview Grid */
        .preview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
            max-height: 200px;
            overflow-y: auto;
        }

        .preview-item {
            position: relative;
            aspect-ratio: 1;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .preview-item button {
            position: absolute;
            top: 2px;
            right: 2px;
            background: rgba(239, 68, 68, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Progress Bar */
        .progress-bar {
            background: #e5e7eb;
            border-radius: 10px;
            height: 30px;
            overflow: hidden;
            margin-bottom: 20px;
            display: none;
        }

        .progress-bar.active {
            display: block;
        }

        .progress-fill {
            background: linear-gradient(135deg, #667eea, #764ba2);
            height: 100%;
            width: 0%;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 14px;
            font-weight: 600;
        }

        /* Buttons */
        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-bottom: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #e5e7eb;
            color: #4b5563;
        }

        .btn-success {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Hidden inputs */
        #fileCamera, #fileGallery {
            display: none;
        }

        /* Mobile optimizations */
        @media (max-width: 480px) {
            .container {
                padding: 20px;
                border-radius: 0;
                min-height: 100vh;
            }
            
            .upload-buttons {
                grid-template-columns: 1fr;
            }
        }

        /* Loading spinner */
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Help text */
        .help-text {
            background: #f3f4f6;
            border-left: 4px solid #667eea;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
            font-size: 14px;
            color: #4b5563;
        }

        .help-text strong {
            color: #1f2937;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üì∏ Trouwfoto's Delen</h1>
            <p>Upload jullie mooiste momenten! üíï</p>
        </div>

        <!-- Status Box -->
        <div id="statusBox" class="status-box status-loading">
            ‚è≥ Pagina wordt geladen...
        </div>

        <!-- Setup Panel (voor admin) -->
        <div id="setupPanel" class="setup-panel" style="display: none;">
            <h2>‚öôÔ∏è Configuratie Setup</h2>
            
            <div class="form-group">
                <label>Google Client ID:</label>
                <input type="text" id="clientId" placeholder="123456.apps.googleusercontent.com">
                <small>Van Google Cloud Console ‚Üí APIs & Services ‚Üí Credentials</small>
            </div>
            
            <div class="form-group">
                <label>Google API Key:</label>
                <input type="password" id="apiKey" placeholder="AIzaSy...">
                <small>Van Google Cloud Console ‚Üí APIs & Services ‚Üí Credentials</small>
            </div>
            
            <div class="form-group">
                <label>Map naam in Google Drive:</label>
                <input type="text" id="folderName" value="Trouwfoto's">
                <small>Waar de foto's opgeslagen worden</small>
            </div>
            
            <div class="form-group">
                <label>Admin wachtwoord:</label>
                <input type="text" id="adminKey" placeholder="geheim123">
                <small>Voor toegang tot dit configuratiescherm</small>
            </div>
            
            <button class="btn btn-success" onclick="saveConfig()">üíæ Configuratie Opslaan</button>
            <button class="btn btn-primary" onclick="testSetup()">üß™ Test Configuratie</button>
            <button class="btn btn-danger" onclick="resetConfig()">üóëÔ∏è Reset Alles</button>
        </div>

        <!-- Upload Panel (voor gasten) -->
        <div id="uploadPanel" class="upload-panel">
            <!-- Upload knoppen -->
            <div class="upload-buttons">
                <div class="upload-btn" onclick="openCamera()">
                    <div class="upload-btn-icon">üì∑</div>
                    <div class="upload-btn-text">Nieuwe foto</div>
                </div>
                <div class="upload-btn" onclick="openGallery()">
                    <div class="upload-btn-icon">üñºÔ∏è</div>
                    <div class="upload-btn-text">Uit galerij</div>
                </div>
            </div>

            <!-- Preview grid -->
            <div id="previewGrid" class="preview-grid"></div>

            <!-- Progress bar -->
            <div id="progressBar" class="progress-bar">
                <div id="progressFill" class="progress-fill">0%</div>
            </div>

            <!-- Upload button -->
            <button id="uploadBtn" class="btn btn-primary" onclick="startUpload()" style="display: none;">
                ‚ú® Upload Foto's
            </button>
        </div>

        <!-- Help text -->
        <div id="helpText" class="help-text" style="display: none;">
            <strong>üí° Hulp nodig?</strong><br>
            Deze app moet eerst geconfigureerd worden door de beheerder.
            Vraag naar de setup-link als je de beheerder bent.
        </div>

        <!-- Hidden file inputs -->
        <input type="file" id="fileCamera" accept="image/*" capture="environment" multiple>
        <input type="file" id="fileGallery" accept="image/*" multiple>
    </div>

    <!-- Google APIs -->
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>

    <script>
        // ===== CONFIGURATION =====
        let CONFIG = {};
        let isAdmin = false;
        let isReady = false;
        let selectedFiles = [];
        let accessToken = null;
        let tokenClient = null;

        // ===== INITIALIZATION =====
        window.onload = function() {
            console.log('üöÄ App starting...');
            
            // Load stored config
            loadConfig();
            
            // Check if admin
            checkAdminMode();
            
            // Initialize app
            initializeApp();
            
            // Setup file handlers
            setupFileHandlers();
        };

        // Load configuration from localStorage
        function loadConfig() {
            const stored = localStorage.getItem('weddingPhotoConfig');
            if (stored) {
                try {
                    CONFIG = JSON.parse(stored);
                    console.log('‚úÖ Config loaded from localStorage');
                } catch (e) {
                    console.error('‚ùå Invalid stored config:', e);
                    showStatus('Configuratie corrupt - reset nodig', 'error');
                }
            }
        }

        // Save configuration
        function saveConfig() {
            CONFIG = {
                CLIENT_ID: document.getElementById('clientId').value.trim(),
                API_KEY: document.getElementById('apiKey').value.trim(),
                FOLDER_NAME: document.getElementById('folderName').value.trim() || 'Trouwfoto's',
                ADMIN_KEY: document.getElementById('adminKey').value.trim() || 'admin123'
            };

            // Validate
            if (!CONFIG.CLIENT_ID || !CONFIG.API_KEY) {
                showStatus('‚ùå Vul alle verplichte velden in!', 'error');
                return;
            }

            // Save to localStorage
            localStorage.setItem('weddingPhotoConfig', JSON.stringify(CONFIG));
            showStatus('‚úÖ Configuratie opgeslagen! Pagina wordt herladen...', 'success');
            
            // Reload after 1.5 seconds
            setTimeout(() => location.reload(), 1500);
        }

        // Reset configuration
        function resetConfig() {
            if (confirm('Weet je zeker dat je alles wilt resetten?')) {
                localStorage.clear();
                sessionStorage.clear();
                showStatus('üóëÔ∏è Alles gewist! Pagina wordt herladen...', 'warning');
                setTimeout(() => location.reload(), 1500);
            }
        }

        // Check admin mode
        function checkAdminMode() {
            const urlParams = new URLSearchParams(window.location.search);
            const key = urlParams.get('key');
            
            // Check for setup mode or admin key
            if (key === 'setup' || (CONFIG.ADMIN_KEY && key === CONFIG.ADMIN_KEY)) {
                isAdmin = true;
                console.log('üîê Admin mode activated');
            }
        }

        // Initialize app
        function initializeApp() {
            if (!CONFIG.CLIENT_ID || !CONFIG.API_KEY) {
                // No config - show setup or help
                if (isAdmin) {
                    showSetupPanel();
                    showStatus('üëã Welkom! Vul je Google credentials in om te beginnen.', 'warning');
                } else {
                    showStatus('‚ö†Ô∏è App is nog niet geconfigureerd', 'warning');
                    document.getElementById('helpText').style.display = 'block';
                }
                return;
            }

            // Config exists - initialize Google API
            showStatus('‚è≥ Google API wordt geladen...', 'loading');
            
            // Load Google API
            gapi.load('client', () => {
                gapi.client.init({
                    apiKey: CONFIG.API_KEY,
                    discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'],
                }).then(() => {
                    console.log('‚úÖ Google API initialized');
                    
                    // Setup OAuth
                    setupOAuth();
                    
                    // Check for existing token
                    checkExistingToken();
                    
                }).catch(error => {
                    console.error('‚ùå Google API init error:', error);
                    showStatus('‚ùå Google API fout - check je credentials', 'error');
                    if (isAdmin) {
                        showSetupPanel();
                    }
                });
            });
        }

        // Setup OAuth
        function setupOAuth() {
            if (!google?.accounts?.oauth2) {
                console.log('‚è≥ Waiting for Google Identity Services...');
                setTimeout(setupOAuth, 500);
                return;
            }

            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CONFIG.CLIENT_ID,
                scope: 'https://www.googleapis.com/auth/drive.file',
                callback: (response) => {
                    if (response.error) {
                        console.error('‚ùå OAuth error:', response);
                        showStatus('‚ùå Login mislukt', 'error');
                        return;
                    }
                    
                    accessToken = response.access_token;
                    
                    // Store token for sharing
                    sessionStorage.setItem('uploadToken', accessToken);
                    localStorage.setItem('sharedToken', accessToken);
                    localStorage.setItem('tokenExpiry', Date.now() + 3600000);
                    
                    console.log('‚úÖ OAuth successful');
                    showStatus('‚úÖ Succesvol ingelogd!', 'success');
                    
                    enableUpload();
                }
            });

            // Auto-request token if admin
            if (isAdmin && !accessToken) {
                setTimeout(() => {
                    showStatus('üìù Login met Google om de app te activeren...', 'warning');
                    tokenClient.requestAccessToken();
                }, 1000);
            }
        }

        // Check existing token
        function checkExistingToken() {
            // Check session token first
            const sessionToken = sessionStorage.getItem('uploadToken');
            if (sessionToken) {
                accessToken = sessionToken;
                enableUpload();
                return;
            }

            // Check shared token
            const sharedToken = localStorage.getItem('sharedToken');
            const tokenExpiry = localStorage.getItem('tokenExpiry');
            
            if (sharedToken && tokenExpiry && Date.now() < parseInt(tokenExpiry)) {
                accessToken = sharedToken;
                enableUpload();
            } else if (!isAdmin) {
                showStatus('‚è≥ Wacht op activatie door beheerder...', 'warning');
                // Keep checking
                setTimeout(checkExistingToken, 5000);
            }
        }

        // Enable upload interface
        function enableUpload() {
            isReady = true;
            document.getElementById('uploadPanel').classList.add('active');
            document.getElementById('setupPanel').style.display = 'none';
            document.getElementById('helpText').style.display = 'none';
            showStatus('‚úÖ Klaar om foto\'s te uploaden!', 'success');
        }

        // Show setup panel
        function showSetupPanel() {
            document.getElementById('setupPanel').style.display = 'block';
            document.getElementById('uploadPanel').classList.remove('active');
            
            // Pre-fill values if they exist
            if (CONFIG.CLIENT_ID) {
                document.getElementById('clientId').value = CONFIG.CLIENT_ID;
                document.getElementById('apiKey').value = CONFIG.API_KEY;
                document.getElementById('folderName').value = CONFIG.FOLDER_NAME;
                document.getElementById('adminKey').value = CONFIG.ADMIN_KEY;
            }
        }

        // Show status message
        function showStatus(message, type) {
            const statusBox = document.getElementById('statusBox');
            statusBox.textContent = message;
            statusBox.className = `status-box status-${type}`;
        }

        // Test setup
        async function testSetup() {
            if (!accessToken) {
                showStatus('‚è≥ Eerst inloggen...', 'warning');
                tokenClient?.requestAccessToken();
                return;
            }

            showStatus('üß™ Test wordt uitgevoerd...', 'loading');

            try {
                // Test Drive API
                const response = await gapi.client.drive.files.list({
                    pageSize: 1,
                    fields: 'files(id, name)'
                });

                showStatus('‚úÖ Test geslaagd! Google Drive werkt.', 'success');
            } catch (error) {
                console.error('Test failed:', error);
                showStatus('‚ùå Test mislukt: ' + error.message, 'error');
            }
        }

        // Setup file handlers
        function setupFileHandlers() {
            const cameraInput = document.getElementById('fileCamera');
            const galleryInput = document.getElementById('fileGallery');
            
            cameraInput.addEventListener('change', handleFiles);
            galleryInput.addEventListener('change', handleFiles);
        }

        // Open camera
        function openCamera() {
            if (!isReady) {
                showStatus('‚ö†Ô∏è App is nog niet klaar', 'warning');
                return;
            }
            document.getElementById('fileCamera').click();
        }

        // Open gallery
        function openGallery() {
            if (!isReady) {
                showStatus('‚ö†Ô∏è App is nog niet klaar', 'warning');
                return;
            }
            document.getElementById('fileGallery').click();
        }

        // Handle files
        function handleFiles(event) {
            const files = Array.from(event.target.files);
            
            // Filter valid images
            const validFiles = files.filter(file => {
                if (!file.type.startsWith('image/')) {
                    showStatus(`‚ùå ${file.name} is geen afbeelding`, 'error');
                    return false;
                }
                if (file.size > 10485760) { // 10MB
                    showStatus(`‚ùå ${file.name} is te groot (max 10MB)`, 'error');
                    return false;
                }
                return true;
            });

            // Add to selection
            selectedFiles = [...selectedFiles, ...validFiles].slice(0, 20);
            
            if (selectedFiles.length >= 20) {
                showStatus('‚ö†Ô∏è Maximum 20 foto\'s bereikt', 'warning');
            }

            // Show previews
            showPreviews();
            
            // Reset input
            event.target.value = '';
        }

        // Show previews
        function showPreviews() {
            const grid = document.getElementById('previewGrid');
            grid.innerHTML = '';
            
            selectedFiles.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const item = document.createElement('div');
                    item.className = 'preview-item';
                    item.innerHTML = `
                        <img src="${e.target.result}" alt="${file.name}">
                        <button onclick="removeFile(${index})">√ó</button>
                    `;
                    grid.appendChild(item);
                };
                reader.readAsDataURL(file);
            });

            // Show/hide upload button
            document.getElementById('uploadBtn').style.display = 
                selectedFiles.length > 0 ? 'block' : 'none';
        }

        // Remove file
        function removeFile(index) {
            selectedFiles.splice(index, 1);
            showPreviews();
        }

        // Start upload
        async function startUpload() {
            if (!accessToken) {
                showStatus('‚ùå Geen toegang tot Google Drive', 'error');
                return;
            }

            if (selectedFiles.length === 0) {
                showStatus('‚ö†Ô∏è Selecteer eerst foto\'s', 'warning');
                return;
            }

            // Disable button
            document.getElementById('uploadBtn').disabled = true;
            
            // Show progress
            document.getElementById('progressBar').classList.add('active');
            
            showStatus(`üì§ ${selectedFiles.length} foto's worden ge√ºpload...`, 'loading');

            try {
                // Get or create folder
                const folderId = await getOrCreateFolder();
                
                // Upload each file
                for (let i = 0; i < selectedFiles.length; i++) {
                    await uploadFile(selectedFiles[i], folderId);
                    updateProgress((i + 1) / selectedFiles.length * 100);
                }

                showStatus(`‚úÖ ${selectedFiles.length} foto's succesvol ge√ºpload!`, 'success');
                
                // Clear selection
                selectedFiles = [];
                showPreviews();
                
            } catch (error) {
                console.error('Upload error:', error);
                showStatus('‚ùå Upload mislukt: ' + error.message, 'error');
            }

            // Re-enable button
            document.getElementById('uploadBtn').disabled = false;
            
            // Hide progress
            setTimeout(() => {
                document.getElementById('progressBar').classList.remove('active');
            }, 2000);
        }

        // Get or create folder
        async function getOrCreateFolder() {
            // Search for folder
            const response = await gapi.client.drive.files.list({
                q: `name='${CONFIG.FOLDER_NAME}' and mimeType='application/vnd.google-apps.folder' and trashed=false`,
                fields: 'files(id, name)',
                spaces: 'drive'
            });

            if (response.result.files && response.result.files.length > 0) {
                return response.result.files[0].id;
            }

            // Create folder
            const folderResponse = await gapi.client.drive.files.create({
                resource: {
                    name: CONFIG.FOLDER_NAME,
                    mimeType: 'application/vnd.google-apps.folder'
                },
                fields: 'id'
            });

            return folderResponse.result.id;
        }

        // Upload file
        async function uploadFile(file, folderId) {
            const metadata = {
                name: `foto_${Date.now()}_${file.name}`,
                parents: [folderId]
            };

            const form = new FormData();
            form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
            form.append('file', file);

            const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${accessToken}`
                },
                body: form
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error?.message || 'Upload failed');
            }

            return response.json();
        }

        // Update progress
        function updateProgress(percent) {
            const fill = document.getElementById('progressFill');
            fill.style.width = percent + '%';
            fill.textContent = Math.round(percent) + '%';
        }
    </script>
</body>
</html>